# $FreeBSD$

mkdir:(file,string,bool)->file = args.mkdir;

opts = args.options;

llvm_gendir = mkdir(gendir, 'llvm');

ir_incdir = llvminclude :: 'IR';
ir_gendir = mkdir(llvm_gendir, 'IR');

mkdir(llvm_gendir, 'llvm-lib');
mkdir(llvm_gendir, 'llvm-dlltool');

#
# Wrapper around llvm-tblgen that uses our common LLVM include directory
#
tblgen = function(source:file, gen_action:string, target:file): file
{
	toolchain.tblgen.llvm(source, target,
	                      flags=['-gen-'+gen_action], includes=[llvmroot::'include'])
}

# llvm-tblgen wrapper for IR tblgen files
ir_tblgen = function(sourcename:string, gen_action:string, targetname:string): file
{
	tblgen(ir_incdir::sourcename, gen_action, ir_gendir::targetname)
}

tool_source_dir = llvmlibdir :: 'ToolDrivers';
tool_options = function(tool_name:string): file
{
    tblgen((tool_source_dir::tool_name)::'Options.td',
           'opt-parser-defs',
           (llvm_gendir::tool_name)::'Options.inc')
};

generated_headers =
[
    tool_options('llvm-dlltool')
    tool_options('llvm-lib')

	ir_tblgen('Attributes.td', 'attrs', 'Attributes.inc')
	ir_tblgen('Intrinsics.td', 'intrinsic-enums', 'IntrinsicEnums.inc')
	ir_tblgen('Intrinsics.td', 'intrinsic-impl', 'IntrinsicImpl.inc')

	tblgen((llvmlibdir::'IR')::'AttributesCompatFunc.td', 'attrs',
	       ir_gendir::'AttributesCompatFunc.inc')

	tblgen(((llvmlibdir::'Transforms')::'InstCombine')::'InstCombineTables.td',
	       'searchable-tables',
	       llvm_gendir::'InstCombineTables.inc')
];


sources =
	import('Analysis.fab').sources
	+
	{
		subdir = llvmlibdir :: 'AsmParser';
		files(LLLexer.cpp LLParser.cpp Parser.cpp)
	}
	+
	{
		subdir = llvmlibdir :: 'BinaryFormat';
		files(Dwarf.cpp Magic.cpp Wasm.cpp)
	}
	+ import('Bitcode.fab').sources
	+ import('CodeGen.fab').sources
	+ import('DebugInfo.fab').sources
	+ import('Demangle.fab').sources
	+ import('ExecutionEngine.fab').sources
	+ import('IR.fab').sources
	+
	{
		subdir = llvmlibdir :: 'IRReader';
		files(IRReader.cpp)
	}
	+ import('LTO.fab').sources
	+
	{
		subdir = llvmlibdir :: 'LineEditor';
		files(LineEditor.cpp)
	}
	+
	{
		subdir = llvmlibdir :: 'Linker';
		files(IRMover.cpp LinkModules.cpp)
	}
	+ import('MC.fab').sources
	+ import('MCA.fab').sources
	+ import('Object.fab').sources
	+ import('ObjectYAML.fab').sources
	+ import('Option.fab').sources
	+ import('ProfileData.fab').sources
	+ import('TableGen.fab').sources
	+
	{
		subdir = llvmlibdir :: 'ToolDrivers';

		file('DlltoolDriver.cpp',
			includes=[(gendir::'llvm')::'llvm-dlltool'],  # TODO: fix `:::`
			subdir=subdir::'llvm-dlltool')
		::
		(if opts.llvm.exl
		{
			file('LibDriver.cpp',
				includes=[(gendir::'llvm')::'llvm-lib'],  # TODO: fix `:::`
				subdir=subdir::'llvm-lib')
		}
		else [])
		::
		files()
	}
	+ import('Targets').sources
	+ import('Transforms').sources
	+ import('Support.fab').sources
	+ import('XRay.fab').sources
	;
